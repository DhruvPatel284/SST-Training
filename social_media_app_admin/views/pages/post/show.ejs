<%- contentFor('HeaderCss') %>

<%- contentFor('body') %>

<div class="row">
  <div class="col-lg-8 mx-auto">

    <!-- Flash success toast -->
    <% if (successMessage) { %>
    <div class="alert alert-success alert-dismissible alert-border-left fade show" role="alert">
      <i class="ri-check-double-line me-2 align-middle"></i>
      <%= successMessage %>
      <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
    </div>
    <% } %>

    <!-- Post Card -->
    <div class="card shadow-sm">
      <div class="card-header d-flex justify-content-between align-items-center">
        <h5 class="card-title mb-0">Post Detail</h5>
        <a href="/posts" class="btn btn-sm btn-outline-secondary">
          <i class="ri-arrow-left-line me-1"></i> Back to List
        </a>
      </div>

      <div class="card-body">

        <!-- Author -->
        <div class="d-flex align-items-center mb-4">
          <%
            const initials = (post.user?.name || '').trim()
              .split(/\s+/)
              .map(n => n.charAt(0))
              .join('')
              .slice(0, 2)
              .toUpperCase();
          %>
          <div class="avatar-sm me-3">
            <div class="avatar-title rounded-circle bg-primary text-white fw-bold fs-14">
              <%= initials || 'U' %>
            </div>
          </div>
          <div>
            <h6 class="mb-0"><%= post.user?.name || 'Unknown' %></h6>
            <small class="text-muted"><%= post.user?.email || '' %></small>
          </div>
          <div class="ms-auto">
            <% if (post.Reviewed) { %>
              <span class="badge bg-success fs-12">
                <i class="ri-shield-check-line me-1"></i> Reviewed
              </span>
            <% } else { %>
              <span class="badge bg-danger fs-12">
                <i class="ri-shield-cross-line me-1"></i> Not Reviewed
              </span>
            <% } %>
          </div>
        </div>

        <!-- Content -->
        <div class="mb-4 p-3 bg-light rounded">
          <p class="mb-0 fs-14"><%= post.content %></p>
        </div>

        <!-- Media Gallery -->
        <% if ((post.images && post.images.length > 0) || (post.videos && post.videos.length > 0)) { %>
        <div class="mb-4">
          <h6 class="mb-3">
            <i class="ri-gallery-line me-1"></i> Media Gallery
          </h6>
          
          <!-- Images -->
          <% if (post.images && post.images.length > 0) { %>
          <div class="mb-3">
            <label class="text-muted fs-12 mb-2">Images (<%= post.images.length %>)</label>
            <div class="d-flex flex-wrap gap-2">
              <% post.images.forEach(function(imageObj) { %>
              <a href="/uploads/posts/<%= imageObj.filename %>" target="_blank">
                <img
                  src="/uploads/posts/<%= imageObj.filename %>"
                  class="img-thumbnail"
                  style="max-width: 150px; max-height: 150px; object-fit: cover; cursor: pointer;"
                  alt="Post image"
                />
              </a>
              <% }); %>
            </div>
          </div>
          <% } %>

          <!-- Videos -->
          <% if (post.videos && post.videos.length > 0) { %>
          <div class="mb-3">
            <label class="text-muted fs-12 mb-2">Videos (<%= post.videos.length %>)</label>
            <div class="d-flex flex-wrap gap-2">
              <% post.videos.forEach(function(videoObj) { %>
              <video
                src="/uploads/posts/<%= videoObj.filename %>"
                class="border rounded"
                style="max-width: 300px; max-height: 200px;"
                controls
              ></video>
              <% }); %>
            </div>
          </div>
          <% } %>
        </div>
        <% } %>

        <!-- Stats row -->
        <div class="row g-3 mb-4">
          <div class="col-6 col-md-4">
            <div class="d-flex align-items-center gap-2">
              <div class="avatar-xs">
                <div class="avatar-title rounded bg-danger-subtle text-danger">
                  <i class="ri-heart-line fs-16"></i>
                </div>
              </div>
              <div>
                <p class="text-muted mb-0 fs-12">Likes</p>
                <h5 class="mb-0"><%= post.likeCount ?? 0 %></h5>
              </div>
            </div>
          </div>
          <div class="col-6 col-md-4">
            <div class="d-flex align-items-center gap-2">
              <div class="avatar-xs">
                <div class="avatar-title rounded bg-info-subtle text-info">
                  <i class="ri-chat-3-line fs-16"></i>
                </div>
              </div>
              <div>
                <p class="text-muted mb-0 fs-12">Comments</p>
                <h5 class="mb-0"><%= post.commentCount ?? 0 %></h5>
              </div>
            </div>
          </div>
          <div class="col-6 col-md-4">
            <div class="d-flex align-items-center gap-2">
              <div class="avatar-xs">
                <div class="avatar-title rounded bg-secondary-subtle text-secondary">
                  <i class="ri-calendar-line fs-16"></i>
                </div>
              </div>
              <div>
                <p class="text-muted mb-0 fs-12">Posted</p>
                <h6 class="mb-0 fs-12"><%= new Date(post.createdAt).toLocaleDateString() %></h6>
              </div>
            </div>
          </div>
        </div>

        <!-- Divider -->
        <hr />

        <!-- Toggle Reviewed Action -->
        <div class="d-flex align-items-center justify-content-between">
          <div>
            <h6 class="mb-1">Review Status</h6>
            <p class="text-muted mb-0 fs-13">
              Controls whether this post is visible to users in the app.
            </p>
          </div>
          <div class="d-flex gap-2">
            <a href="/posts/<%= post.id %>/edit" class="btn btn-success">
              <i class="ri-edit-line me-1"></i> Edit
            </a>
            <form action="/posts/<%= post.id %>?_method=DELETE" method="POST" class="d-inline">
              <button
                type="submit"
                class="btn btn-danger"
                onclick="return confirm('Are you sure you want to delete this post?')"
              >
                <i class="ri-delete-bin-line me-1"></i> Delete
              </button>
            </form>
            <form action="/posts/<%= post.id %>/toggle-reviewed" method="POST" class="d-inline">
              <% if (post.Reviewed) { %>
                <button type="submit" class="btn btn-warning"
                  onclick="return confirm('Mark this post as NOT reviewed? It will be hidden from users.')">
                  <i class="ri-shield-cross-line me-1"></i> Mark as Unreviewed
                </button>
              <% } else { %>
                <button type="submit" class="btn btn-primary"
                  onclick="return confirm('Approve this post? It will become visible to users.')">
                  <i class="ri-shield-check-line me-1"></i> Mark as Reviewed
                </button>
              <% } %>
            </form>
          </div>
        </div>

      </div>
      <!-- end card-body -->
    </div>
    <!-- end card -->

    <!-- Comments section (read-only) -->
    <% if (post.comments && post.comments.length > 0) { %>
    <div class="card shadow-sm mt-4">
      <div class="card-header">
        <h6 class="card-title mb-0">
          <i class="ri-chat-3-line me-1"></i> Comments (<%= post.commentCount %>)
        </h6>
      </div>
      <div class="card-body">
        <ul class="list-group list-group-flush">
          <% post.comments.forEach(comment => { %>
          <li class="list-group-item px-0">
            <div class="d-flex gap-2">
              <div class="flex-shrink-0">
                <div class="avatar-xxs">
                  <div class="avatar-title rounded-circle bg-secondary-subtle text-secondary fw-semibold">
                    <%= (comment.user?.name || 'U').charAt(0).toUpperCase() %>
                  </div>
                </div>
              </div>
              <div>
                <h6 class="mb-1 fs-13"><%= comment.user?.name || 'Anonymous' %></h6>
                <p class="mb-0 text-muted fs-13"><%= comment.content %></p>
              </div>
            </div>
          </li>
          <% }) %>
        </ul>
      </div>
    </div>
    <% } %>

  </div>
</div>

<%- contentFor('FooterJs') %>

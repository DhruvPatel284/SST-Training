<%- contentFor('HeaderCss') %>
<link href="/assets/libs/sweetalert2/sweetalert2.min.css" rel="stylesheet" type="text/css" />

<style>
  .user-card {
    transition: all 0.3s ease;
  }
  .user-card:hover {
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
    transform: translateY(-2px);
  }
  .user-avatar {
    width: 80px;
    height: 80px;
    border-radius: 50%;
    object-fit: cover;
  }
  .avatar-circle-search {
    width: 80px;
    height: 80px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    font-weight: 700;
    font-size: 32px;
  }
</style>

<%- contentFor('body') %>

<div class="row">
  <div class="col-12">
    
    <div class="card mb-3">
      <div class="card-body">
        <div class="d-flex align-items-center justify-content-between">
          <div>
            <h4 class="mb-1">Search Users</h4>
            <p class="text-muted mb-0">Find and connect with other users</p>
          </div>
          <a href="/user/search/follow-requests" class="btn btn-soft-primary">
            <i class="ri-user-add-line me-1"></i> Follow Requests
            <% if (pendingRequestsCount > 0) { %>
              <span class="badge bg-danger ms-1"><%= pendingRequestsCount %></span>
            <% } %>
          </a>
        </div>
      </div>
    </div>

    <div class="card mb-3">
      <div class="card-body">
        <form action="/user/search" method="GET">
          <div class="input-group">
            <span class="input-group-text">
              <i class="ri-search-line"></i>
            </span>
            <input 
              type="text" 
              class="form-control" 
              name="q" 
              placeholder="Search by name or email..." 
              value="<%= query || '' %>"
              autofocus
            >
            <button class="btn btn-primary" type="submit">
              <i class="ri-search-line me-1"></i> Search
            </button>
          </div>
        </form>
      </div>
    </div>

    <% if (query) { %>
      <div class="card">
        <div class="card-header">
          <h5 class="mb-0">
            Search Results 
            <% if (searchResults && searchResults.length > 0) { %>
              <span class="badge bg-primary"><%= searchResults.length %></span>
            <% } %>
          </h5>
        </div>
        <div class="card-body">
          <% if (searchResults && searchResults.length > 0) { %>
            <div class="row">
              <% searchResults.forEach(function(searchUser) { %>
                <div class="col-xl-3 col-lg-4 col-md-6 mb-3">
                  <div class="card user-card h-100">
                    <div class="card-body text-center">
                      
                      <a href="/user/profile/<%= searchUser.id %>">
                        <% if (searchUser.profile_image) { %>
                          <img src="/uploads/users/<%= searchUser.profile_image %>" class="user-avatar mb-3" alt="<%= searchUser.name %>">
                        <% } else { %>
                          <div class="avatar-circle-search bg-primary-subtle text-primary mx-auto mb-3">
                            <%= searchUser.name.charAt(0).toUpperCase() %>
                          </div>
                        <% } %>
                      </a>

                      <h6 class="mb-1">
                        <a href="/user/profile/<%= searchUser.id %>" class="text-dark">
                          <%= searchUser.name %>
                        </a>
                      </h6>
                      <p class="text-muted mb-3 small"><%= searchUser.email %></p>

                      <div class="d-grid gap-2">
                        <% if (searchUser.followStatus === 'accepted') { %>
                          <button 
                            class="btn btn-success btn-sm follow-btn"
                            data-user-id="<%= searchUser.id %>"
                            data-status="accepted"
                            data-bs-toggle="modal" 
                            data-bs-target="#actionConfirmationModal"
                            onclick="prepareAction('unfollow', '<%= searchUser.id %>', this)"
                          >
                            <i class="ri-user-follow-line me-1"></i> Following
                          </button>
                        <% } else if (searchUser.followStatus === 'pending') { %>
                          <button 
                            class="btn btn-secondary btn-sm"
                            data-user-id="<%= searchUser.id %>"
                            data-status="pending"
                            data-bs-toggle="modal" 
                            data-bs-target="#actionConfirmationModal"
                            onclick="prepareAction('cancel', '<%= searchUser.id %>', this)"
                          >
                            <i class="ri-time-line me-1"></i> Requested
                          </button>
                        <% } else { %>
                          <button 
                            class="btn btn-primary btn-sm follow-btn"
                            data-user-id="<%= searchUser.id %>"
                            data-status="none"
                            onclick="sendFollowRequest('<%= searchUser.id %>', this)"
                          >
                            <i class="ri-user-add-line me-1"></i> Follow
                          </button>
                        <% } %>

                        <a href="/user/profile/<%= searchUser.id %>" class="btn btn-soft-secondary btn-sm">
                          <i class="ri-eye-line me-1"></i> View Profile
                        </a>
                      </div>

                    </div>
                  </div>
                </div>
              <% }) %>
            </div>
          <% } else { %>
            <div class="text-center py-5">
              <lord-icon src="https://cdn.lordicon.com/msoeawqm.json" trigger="loop" colors="primary:#405189" style="width:100px;height:100px"></lord-icon>
              <h5 class="mt-3">No Users Found</h5>
              <p class="text-muted">Try searching with different keywords</p>
            </div>
          <% } %>
        </div>
      </div>

    <% } else { %>
      <div class="card">
        <div class="card-header">
          <h5 class="mb-0">
            <i class="ri-user-star-line me-2"></i> Suggested Users
          </h5>
        </div>
        <div class="card-body">
          <% if (suggestedUsers && suggestedUsers.length > 0) { %>
            <div class="row">
              <% suggestedUsers.forEach(function(suggestedUser) { %>
                <div class="col-xl-3 col-lg-4 col-md-6 mb-3">
                  <div class="card user-card h-100">
                    <div class="card-body text-center">
                      
                      <a href="/user/profile/<%= suggestedUser.id %>">
                        <% if (suggestedUser.profile_image) { %>
                          <img src="/uploads/users/<%= suggestedUser.profile_image %>" class="user-avatar mb-3" alt="<%= suggestedUser.name %>">
                        <% } else { %>
                          <div class="avatar-circle-search bg-info-subtle text-info mx-auto mb-3">
                            <%= suggestedUser.name.charAt(0).toUpperCase() %>
                          </div>
                        <% } %>
                      </a>

                      <h6 class="mb-1">
                        <a href="/user/profile/<%= suggestedUser.id %>" class="text-dark">
                          <%= suggestedUser.name %>
                        </a>
                      </h6>
                      <p class="text-muted mb-3 small"><%= suggestedUser.email %></p>

                      <div class="d-grid gap-2">
                        <% if (suggestedUser.followStatus === 'accepted') { %>
                          <button 
                            class="btn btn-success btn-sm follow-btn"
                            data-user-id="<%= suggestedUser.id %>"
                            data-status="accepted"
                            data-bs-toggle="modal" 
                            data-bs-target="#actionConfirmationModal"
                            onclick="prepareAction('unfollow', '<%= suggestedUser.id %>', this)"
                          >
                            <i class="ri-user-follow-line me-1"></i> Following
                          </button>
                        <% } else if (suggestedUser.followStatus === 'pending') { %>
                          <button 
                            class="btn btn-secondary btn-sm"
                            data-user-id="<%= suggestedUser.id %>"
                            data-status="pending"
                            data-bs-toggle="modal" 
                            data-bs-target="#actionConfirmationModal"
                            onclick="prepareAction('cancel', '<%= suggestedUser.id %>', this)"
                          >
                            <i class="ri-time-line me-1"></i> Requested
                          </button>
                        <% } else { %>
                          <button 
                            class="btn btn-primary btn-sm follow-btn"
                            data-user-id="<%= suggestedUser.id %>"
                            data-status="none"
                            onclick="sendFollowRequest('<%= suggestedUser.id %>', this)"
                          >
                            <i class="ri-user-add-line me-1"></i> Follow
                          </button>
                        <% } %>

                        <a href="/user/profile/<%= suggestedUser.id %>" class="btn btn-soft-secondary btn-sm">
                          <i class="ri-eye-line me-1"></i> View Profile
                        </a>
                      </div>

                    </div>
                  </div>
                </div>
              <% }) %>
            </div>
          <% } else { %>
            <div class="text-center py-5">
              <lord-icon src="https://cdn.lordicon.com/nocovwne.json" trigger="loop" colors="primary:#405189" style="width:100px;height:100px"></lord-icon>
              <h5 class="mt-3">No Suggestions</h5>
              <p class="text-muted">You're already connected with everyone!</p>
            </div>
          <% } %>
        </div>
      </div>
    <% } %>

  </div>
</div>

<div class="modal fade zoomIn" id="actionConfirmationModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header">
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close" id="actionConfirmationModal-close"></button>
      </div>
      <div class="modal-body">
        <form id="action-form" method="POST">
          <div class="mt-2 text-center">
            <lord-icon
              src="https://cdn.lordicon.com/gsqxdxog.json"
              trigger="loop"
              colors="primary:#f7b84b,secondary:#f06548"
              style="width: 100px; height: 100px"
            ></lord-icon>
            <div class="mt-4 pt-2 fs-15 mx-4 mx-sm-5">
              <h4>Are you sure?</h4>
              <p class="text-muted mx-4 mb-0" id="action-modal-text">
                Are you sure you want to perform this action?
              </p>
            </div>
          </div>
          <div class="d-flex gap-2 justify-content-center mt-4 mb-2">
            <button type="button" class="btn w-sm btn-light" data-bs-dismiss="modal">Close</button>
            <button type="submit" class="btn w-sm btn-danger" id="action-confirmation">Yes, Proceed</button>
          </div>
        </form>
      </div>
    </div>
  </div>
</div>

<%- contentFor('FooterJs') %>
<script src="/assets/libs/sweetalert2/sweetalert2.min.js"></script>

<script>
// Globals to keep track of which user/button triggered the modal
let targetUserId = null;
let targetButton = null;
let currentActionType = null;

// ─── SEND FOLLOW REQUEST ─────────────────────────────────────────────────────
async function sendFollowRequest(userId, button) {
  try {
    button.disabled = true;
    button.innerHTML = '<span class="spinner-border spinner-border-sm me-1"></span> Sending...';

    const response = await fetch(`/user/search/${userId}/follow`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
    });

    const data = await response.json();

    if (data.success) {
      // Update UI to 'Requested'
      button.classList.remove('btn-primary');
      button.classList.add('btn-secondary');
      button.innerHTML = '<i class="ri-time-line me-1"></i> Requested';
      button.dataset.status = 'pending';
      
      // Wire up the button to trigger the cancel modal on next click
      button.setAttribute('data-bs-toggle', 'modal');
      button.setAttribute('data-bs-target', '#actionConfirmationModal');
      button.onclick = () => prepareAction('cancel', userId, button);

    } else {
      Swal.fire('Error', data.error || 'Failed to send request', 'error');
      button.innerHTML = '<i class="ri-user-add-line me-1"></i> Follow';
    }
  } catch (error) {
    console.error('Follow request error:', error);
    Swal.fire('Error', 'Failed to send request', 'error');
    button.innerHTML = '<i class="ri-user-add-line me-1"></i> Follow';
  } finally {
    button.disabled = false;
  }
}

// ─── MODAL PREPARATION & SUBMISSION LOGIC ────────────────────────────────────

// Set up the modal data before it opens
function prepareAction(actionType, userId, buttonElement) {
  targetUserId = userId;
  targetButton = buttonElement;
  currentActionType = actionType;

  const modalText = document.getElementById('action-modal-text');
  const confirmBtn = document.getElementById('action-confirmation');

  if (actionType === 'unfollow') {
    modalText.innerText = "Are you sure you want to unfollow this user?";
    confirmBtn.innerText = "Yes, Unfollow";
  } else if (actionType === 'cancel') {
    modalText.innerText = "Are you sure you want to cancel this follow request?";
    confirmBtn.innerText = "Yes, Cancel Request";
  }
}

// Handle form submission from inside the modal
document.getElementById('action-form').addEventListener('submit', async function(e) {
  e.preventDefault();
  
  if (!targetUserId || !targetButton) return;

  const submitBtn = document.getElementById('action-confirmation');
  const originalText = submitBtn.innerText;

  try {
    submitBtn.disabled = true;
    submitBtn.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span> Processing...';

    // Both unfollow and cancel hit the same DELETE endpoint
    const response = await fetch(`/user/search/${targetUserId}/follow`, {
      method: 'DELETE',
    });

    if (response.ok) {
      // Revert button back to 'Follow' state
      targetButton.classList.remove('btn-success', 'btn-secondary');
      targetButton.classList.add('btn-primary');
      targetButton.innerHTML = '<i class="ri-user-add-line me-1"></i> Follow';
      targetButton.dataset.status = 'none';
      
      // Remove modal triggers so it behaves like a standard Follow button again
      targetButton.removeAttribute('data-bs-toggle');
      targetButton.removeAttribute('data-bs-target');
      
      // Keep track of the current scope variables for the closure
      const currentId = targetUserId;
      const currentBtn = targetButton;
      
      targetButton.onclick = () => sendFollowRequest(currentId, currentBtn);

      // Close the modal
      document.getElementById('actionConfirmationModal-close').click();
    } else {
      throw new Error('Failed to complete action');
    }
  } catch (error) {
    console.error('Action error:', error);
    Swal.fire('Error', error.message || 'An unexpected error occurred', 'error');
  } finally {
    submitBtn.disabled = false;
    submitBtn.innerText = originalText;
  }
});
</script>
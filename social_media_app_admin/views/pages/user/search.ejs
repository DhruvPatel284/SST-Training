<%- contentFor('HeaderCss') %>
<style>
  .user-card {
    transition: all 0.3s ease;
  }
  .user-card:hover {
    box-shadow: 0 8px 24px rgba(0, 0, 0, 0.12);
    transform: translateY(-2px);
  }
  .avatar-large {
    width: 80px;
    height: 80px;
    border-radius: 50%;
    object-fit: cover;
  }
  .avatar-circle-large {
    width: 80px;
    height: 80px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    font-weight: 700;
    font-size: 32px;
  }
  .search-input-wrapper {
    position: relative;
  }
  .search-input-wrapper .search-icon {
    position: absolute;
    left: 16px;
    top: 50%;
    transform: translateY(-50%);
    color: #878a99;
  }
  .search-input-wrapper input {
    padding-left: 48px;
  }
</style>

<%- contentFor('body') %>

<div class="row">
  <div class="col-12">
    
    <!-- Search Bar -->
    <div class="card mb-4">
      <div class="card-body">
        <form action="/user/search" method="GET" id="search-form">
          <div class="search-input-wrapper">
            <i class="ri-search-line search-icon fs-18"></i>
            <input 
              type="text" 
              class="form-control form-control-lg" 
              name="q" 
              id="search-input"
              placeholder="Search users by name or email..."
              value="<%= searchQuery %>"
              autocomplete="off"
            >
          </div>
        </form>
        <div class="mt-3">
          <% if (searchQuery) { %>
            <p class="text-muted mb-0">
              <i class="ri-information-line me-1"></i>
              Showing results for "<strong><%= searchQuery %></strong>"
              <a href="/user/search" class="ms-2 text-primary">Clear search</a>
            </p>
          <% } else { %>
            <p class="text-muted mb-0">
              <i class="ri-lightbulb-line me-1"></i>
              Suggested users you might want to follow
            </p>
          <% } %>
        </div>
      </div>
    </div>

    <!-- Users Grid -->
    <% if (users && users.length > 0) { %>
      <div class="row" id="users-grid">
        <% users.forEach(function(targetUser) { %>
          <div class="col-xl-3 col-lg-4 col-md-6 mb-3">
            <div class="card user-card h-100">
              <div class="card-body text-center">
                
                <!-- Avatar -->
                <a href="/user/profile/<%= targetUser.id %>">
                  <% if (targetUser.profile_image) { %>
                    <img src="/uploads/users/<%= targetUser.profile_image %>" class="avatar-large mb-3" alt="<%= targetUser.name %>">
                  <% } else { %>
                    <div class="avatar-circle-large bg-primary-subtle text-primary mx-auto mb-3">
                      <%= targetUser.name.charAt(0).toUpperCase() %>
                    </div>
                  <% } %>
                </a>

                <!-- User Info -->
                <h5 class="mb-1">
                  <a href="/user/profile/<%= targetUser.id %>" class="text-dark">
                    <%= targetUser.name %>
                  </a>
                </h5>
                <p class="text-muted mb-3" style="font-size: 14px;"><%= targetUser.email %></p>

                <!-- Follow Button -->
                <% const isFollowing = followingMap.has(targetUser.id); %>
                <button 
                  class="btn <%= isFollowing ? 'btn-success' : 'btn-primary' %> w-100 follow-btn"
                  data-user-id="<%= targetUser.id %>"
                  data-following="<%= isFollowing %>"
                  onclick="toggleFollow('<%= targetUser.id %>', this)"
                >
                  <% if (isFollowing) { %>
                    <i class="ri-user-follow-line me-1"></i> Following
                  <% } else { %>
                    <i class="ri-user-add-line me-1"></i> Follow
                  <% } %>
                </button>

                <!-- View Profile Button -->
                <a href="/user/profile/<%= targetUser.id %>" class="btn btn-soft-secondary w-100 mt-2">
                  <i class="ri-eye-line me-1"></i> View Profile
                </a>

              </div>
            </div>
          </div>
        <% }) %>
      </div>
    <% } else { %>
      
      <!-- Empty State -->
      <div class="card">
        <div class="card-body text-center py-5">
          <% if (searchQuery) { %>
            <!-- No Search Results -->
            <lord-icon src="https://cdn.lordicon.com/msoeawqm.json" trigger="loop" colors="primary:#405189,secondary:#0ab39c" style="width:120px;height:120px"></lord-icon>
            <h5 class="mt-4">No users found</h5>
            <p class="text-muted">Try searching with a different keyword</p>
            <a href="/user/search" class="btn btn-primary mt-3">
              <i class="ri-arrow-left-line me-1"></i> Clear Search
            </a>
          <% } else { %>
            <!-- No Suggestions -->
            <lord-icon src="https://cdn.lordicon.com/nocovwne.json" trigger="loop" colors="primary:#405189,secondary:#0ab39c" style="width:120px;height:120px"></lord-icon>
            <h5 class="mt-4">All caught up!</h5>
            <p class="text-muted">You're following everyone available. Check back later for new users.</p>
          <% } %>
        </div>
      </div>

    <% } %>

  </div>
</div>

<%- contentFor('FooterJs') %>
<script>
// ─── TOGGLE FOLLOW/UNFOLLOW ─────────────────────────────────────────────────
async function toggleFollow(userId, button) {
  const isFollowing = button.dataset.following === 'true';

  try {
    // Optimistic UI update
    button.disabled = true;

    const response = await fetch(`/user/search/${userId}/follow`, {
      method: isFollowing ? 'DELETE' : 'POST',
      headers: { 'Content-Type': 'application/json' },
    });

    if (response.ok) {
      const data = await response.json();

      if (data.success) {
        // Update button state
        if (isFollowing) {
          // Now unfollowed
          button.className = 'btn btn-primary w-100 follow-btn';
          button.innerHTML = '<i class="ri-user-add-line me-1"></i> Follow';
          button.dataset.following = 'false';
        } else {
          // Now following
          button.className = 'btn btn-success w-100 follow-btn';
          button.innerHTML = '<i class="ri-user-follow-line me-1"></i> Following';
          button.dataset.following = 'true';
        }
      }
    } else {
      const error = await response.json();
      alert(error.error || 'Failed to update follow status');
    }
  } catch (error) {
    console.error('Follow error:', error);
    alert('Failed to update follow status');
  } finally {
    button.disabled = false;
  }
}

// ─── LIVE SEARCH (OPTIONAL) ──────────────────────────────────────────────────
let searchTimeout;
const searchInput = document.getElementById('search-input');

searchInput.addEventListener('input', function(e) {
  clearTimeout(searchTimeout);
  
  const query = e.target.value.trim();

  if (query.length < 2) {
    return; // Don't search for very short queries
  }

  // Debounce search
  searchTimeout = setTimeout(() => {
    liveSearch(query);
  }, 500);
});

async function liveSearch(query) {
  try {
    const response = await fetch(`/user/search/api?q=${encodeURIComponent(query)}`);
    const data = await response.json();

    if (data.success) {
      renderSearchResults(data.users);
    }
  } catch (error) {
    console.error('Live search error:', error);
  }
}

function renderSearchResults(users) {
  const grid = document.getElementById('users-grid');
  
  if (users.length === 0) {
    grid.innerHTML = `
      <div class="col-12">
        <div class="card">
          <div class="card-body text-center py-5">
            <lord-icon src="https://cdn.lordicon.com/msoeawqm.json" trigger="loop" colors="primary:#405189,secondary:#0ab39c" style="width:120px;height:120px"></lord-icon>
            <h5 class="mt-4">No users found</h5>
            <p class="text-muted">Try searching with a different keyword</p>
          </div>
        </div>
      </div>
    `;
    return;
  }

  grid.innerHTML = users.map(user => `
    <div class="col-xl-3 col-lg-4 col-md-6 mb-3">
      <div class="card user-card h-100">
        <div class="card-body text-center">
          <a href="/user/profile/${user.id}">
            ${user.profile_image 
              ? `<img src="/uploads/users/${user.profile_image}" class="avatar-large mb-3" alt="${user.name}">`
              : `<div class="avatar-circle-large bg-primary-subtle text-primary mx-auto mb-3">${user.name.charAt(0).toUpperCase()}</div>`
            }
          </a>
          <h5 class="mb-1">
            <a href="/user/profile/${user.id}" class="text-dark">${user.name}</a>
          </h5>
          <p class="text-muted mb-3" style="font-size: 14px;">${user.email}</p>
          <button 
            class="btn ${user.isFollowing ? 'btn-success' : 'btn-primary'} w-100 follow-btn"
            data-user-id="${user.id}"
            data-following="${user.isFollowing}"
            onclick="toggleFollow('${user.id}', this)"
          >
            ${user.isFollowing 
              ? '<i class="ri-user-follow-line me-1"></i> Following'
              : '<i class="ri-user-add-line me-1"></i> Follow'
            }
          </button>
          <a href="/user/profile/${user.id}" class="btn btn-soft-secondary w-100 mt-2">
            <i class="ri-eye-line me-1"></i> View Profile
          </a>
        </div>
      </div>
    </div>
  `).join('');
}

// ─── SUBMIT ON ENTER ─────────────────────────────────────────────────────────
searchInput.addEventListener('keypress', function(e) {
  if (e.key === 'Enter') {
    e.preventDefault();
    document.getElementById('search-form').submit();
  }
});
</script>

<%# views/pages/user/dashboard.ejs %>

<!-- ========================
     PAGE-SPECIFIC CSS
======================== -->
<style>
  /* Feed layout */
  .feed-wrapper {
    display: grid;
    grid-template-columns: 1fr 320px;
    gap: 24px;
    align-items: start;
  }

  @media (max-width: 991px) {
    .feed-wrapper { grid-template-columns: 1fr; }
    .feed-sidebar { display: none; }
  }

  /* Create post card */
  .create-post-card .avatar-trigger {
    width: 42px;
    height: 42px;
    border-radius: 50%;
    object-fit: cover;
    flex-shrink: 0;
  }

  .create-post-card .avatar-initials {
    width: 42px;
    height: 42px;
    border-radius: 50%;
    background: var(--vz-primary);
    color: #fff;
    font-weight: 600;
    font-size: 14px;
    display: flex;
    align-items: center;
    justify-content: center;
    flex-shrink: 0;
  }

  .create-post-trigger {
    flex: 1;
    border: 1.5px solid var(--vz-border-color);
    border-radius: 20px;
    padding: 10px 18px;
    cursor: pointer;
    color: var(--vz-secondary-color);
    font-size: 14px;
    background: var(--vz-secondary-bg);
    transition: border-color 0.2s;
  }
  .create-post-trigger:hover { border-color: var(--vz-primary); }

  /* Post card */
  .post-card {
    border: none;
    border-radius: 12px;
    box-shadow: 0 1px 6px rgba(0,0,0,.06);
    margin-bottom: 20px;
    overflow: hidden;
    transition: box-shadow 0.2s;
  }
  .post-card:hover { box-shadow: 0 4px 16px rgba(0,0,0,.10); }

  .post-card .post-avatar {
    width: 40px;
    height: 40px;
    border-radius: 50%;
    object-fit: cover;
  }

  .post-card .post-avatar-initials {
    width: 40px;
    height: 40px;
    border-radius: 50%;
    background: var(--vz-primary);
    color: #fff;
    font-weight: 600;
    font-size: 13px;
    display: flex;
    align-items: center;
    justify-content: center;
    flex-shrink: 0;
  }

  .post-username {
    font-weight: 600;
    font-size: 14px;
    color: var(--vz-heading-color);
    text-decoration: none;
  }
  .post-username:hover { color: var(--vz-primary); }

  .post-timestamp {
    font-size: 12px;
    color: var(--vz-secondary-color);
  }

  .post-content-text {
    font-size: 14.5px;
    line-height: 1.6;
    color: var(--vz-body-color);
    margin-bottom: 0;
  }

  /* Media grid */
  .media-grid {
    display: grid;
    gap: 3px;
    margin-top: 12px;
    border-radius: 8px;
    overflow: hidden;
  }

  .media-grid.count-1 { grid-template-columns: 1fr; }
  .media-grid.count-2 { grid-template-columns: 1fr 1fr; }
  .media-grid.count-3 { grid-template-columns: 1fr 1fr; }
  .media-grid.count-3 .media-item:first-child { grid-column: 1 / -1; }
  .media-grid.count-4,
  .media-grid.count-many { grid-template-columns: 1fr 1fr; }

  .media-item {
    position: relative;
    overflow: hidden;
    background: #000;
  }
  .media-item img {
    width: 100%;
    height: 260px;
    object-fit: cover;
    display: block;
    cursor: pointer;
    transition: transform 0.3s;
  }
  .media-grid.count-1 .media-item img { height: 380px; }
  .media-item img:hover { transform: scale(1.02); }

  .media-item video {
    width: 100%;
    height: 260px;
    object-fit: cover;
    display: block;
  }

  .media-more-overlay {
    position: absolute;
    inset: 0;
    background: rgba(0,0,0,0.55);
    display: flex;
    align-items: center;
    justify-content: center;
    color: #fff;
    font-size: 24px;
    font-weight: 700;
    cursor: pointer;
  }

  /* Action bar */
  .post-actions {
    border-top: 1px solid var(--vz-border-color);
    padding: 8px 0 4px;
    margin-top: 12px;
  }

  .action-btn {
    border: none;
    background: none;
    display: flex;
    align-items: center;
    gap: 5px;
    font-size: 13px;
    color: var(--vz-secondary-color);
    padding: 6px 10px;
    border-radius: 6px;
    cursor: pointer;
    transition: background 0.15s, color 0.15s;
  }
  .action-btn:hover { background: var(--vz-secondary-bg); color: var(--vz-primary); }
  .action-btn i { font-size: 18px; }
  .action-btn.liked { color: #e53e3e; }
  .action-btn.liked i::before { content: "\ed43"; } /* ri-heart-fill */

  /* Comments preview */
  .comments-preview { margin-top: 10px; }
  .comment-preview-item {
    display: flex;
    gap: 8px;
    margin-bottom: 6px;
    font-size: 13px;
  }
  .comment-preview-item .commenter-name {
    font-weight: 600;
    color: var(--vz-heading-color);
    margin-right: 4px;
  }
  .comment-preview-item .commenter-text {
    color: var(--vz-body-color);
  }
  .comment-mini-avatar {
    width: 26px;
    height: 26px;
    border-radius: 50%;
    object-fit: cover;
    flex-shrink: 0;
  }
  .comment-mini-initials {
    width: 26px;
    height: 26px;
    border-radius: 50%;
    background: var(--vz-secondary-bg);
    border: 1px solid var(--vz-border-color);
    font-size: 10px;
    font-weight: 600;
    display: flex;
    align-items: center;
    justify-content: center;
    flex-shrink: 0;
  }

  /* Sidebar cards */
  .sidebar-card {
    border: none;
    border-radius: 12px;
    box-shadow: 0 1px 6px rgba(0,0,0,.06);
    margin-bottom: 20px;
  }

  .sidebar-profile-avatar {
    width: 64px;
    height: 64px;
    border-radius: 50%;
    object-fit: cover;
    border: 3px solid var(--vz-primary);
  }

  .sidebar-profile-initials {
    width: 64px;
    height: 64px;
    border-radius: 50%;
    background: var(--vz-primary);
    color: #fff;
    font-size: 22px;
    font-weight: 700;
    display: flex;
    align-items: center;
    justify-content: center;
    border: 3px solid var(--vz-primary);
  }

  .stat-item {
    text-align: center;
    flex: 1;
  }
  .stat-item .stat-number {
    font-size: 18px;
    font-weight: 700;
    color: var(--vz-heading-color);
    display: block;
  }
  .stat-item .stat-label {
    font-size: 11px;
    color: var(--vz-secondary-color);
    text-transform: uppercase;
    letter-spacing: 0.5px;
  }

  .suggested-user-item {
    display: flex;
    align-items: center;
    gap: 10px;
    padding: 8px 0;
    border-bottom: 1px solid var(--vz-border-color);
  }
  .suggested-user-item:last-child { border-bottom: none; }

  .suggested-avatar {
    width: 36px;
    height: 36px;
    border-radius: 50%;
    object-fit: cover;
    flex-shrink: 0;
  }
  .suggested-initials {
    width: 36px;
    height: 36px;
    border-radius: 50%;
    background: var(--vz-success);
    color: #fff;
    font-size: 12px;
    font-weight: 600;
    display: flex;
    align-items: center;
    justify-content: center;
    flex-shrink: 0;
  }
  .suggested-name {
    flex: 1;
    font-size: 13px;
    font-weight: 600;
    color: var(--vz-heading-color);
    text-decoration: none;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
  }

  /* Empty state */
  .empty-feed {
    text-align: center;
    padding: 60px 24px;
  }
  .empty-feed i {
    font-size: 56px;
    color: var(--vz-secondary-color);
    opacity: 0.5;
    display: block;
    margin-bottom: 16px;
  }
</style>

<!-- ========================
     PAGE BODY
======================== -->
<div class="page-content">
  <div class="container-fluid">

    <!-- Page title -->
    <div class="row mb-3">
      <div class="col-12">
        <h4 class="mb-0 fw-semibold">Home</h4>
        <p class="text-muted mb-0 fs-13">Your feed</p>
      </div>
    </div>

    <div class="feed-wrapper">

      <!-- ========================
           LEFT: MAIN FEED
      ======================== -->
      <div class="feed-main">

        <!-- Create Post Card -->
        <div class="card create-post-card mb-4" style="border:none; border-radius:12px; box-shadow:0 1px 6px rgba(0,0,0,.06);">
          <div class="card-body">
            <div class="d-flex align-items-center gap-3">
              <% if (currentUser.profile_image) { %>
                <img src="/uploads/users/<%= currentUser.profile_image %>" alt="You" class="avatar-trigger">
              <% } else { %>
                <div class="avatar-initials">
                  <%= currentUser.name ? currentUser.name.charAt(0).toUpperCase() : 'U' %>
                </div>
              <% } %>
              <div class="create-post-trigger" data-bs-toggle="modal" data-bs-target="#createPostModal">
                What's on your mind, <%= currentUser.name ? currentUser.name.split(' ')[0] : 'there' %>?
              </div>
            </div>
            <hr class="my-3">
            <div class="d-flex gap-2 justify-content-center">
              <button class="btn btn-sm btn-soft-primary" data-bs-toggle="modal" data-bs-target="#createPostModal">
                <i class="ri-image-line me-1"></i> Photo
              </button>
              <button class="btn btn-sm btn-soft-success" data-bs-toggle="modal" data-bs-target="#createPostModal">
                <i class="ri-video-line me-1"></i> Video
              </button>
              <button class="btn btn-sm btn-soft-info" data-bs-toggle="modal" data-bs-target="#createPostModal">
                <i class="ri-edit-line me-1"></i> Post
              </button>
            </div>
          </div>
        </div>

        <!-- ===================== FEED POSTS ===================== -->
        <% if (!posts || posts.length === 0) { %>
          <!-- Empty State -->
          <div class="card post-card">
            <div class="card-body empty-feed">
              <i class="ri-newspaper-line"></i>
              <h5 class="text-muted fw-normal mb-2">Your feed is empty</h5>
              <p class="text-muted fs-13 mb-4">Follow people to see their posts here, or create your first post!</p>
              <a href="/user/search" class="btn btn-primary me-2">
                <i class="ri-user-search-line me-1"></i> Find people to follow
              </a>
              <button class="btn btn-outline-primary" data-bs-toggle="modal" data-bs-target="#createPostModal">
                <i class="ri-add-line me-1"></i> Create Post
              </button>
            </div>
          </div>
        <% } else { %>
          <% posts.forEach(function(post) {
            const isOwn = post.user.id === currentUser.id;
            const allMedia = post.media || [];
            const images = allMedia.filter(m => m.type === 'image');
            const videos = allMedia.filter(m => m.type === 'video');
            const displayMedia = [...images, ...videos];
            const extraCount = displayMedia.length > 4 ? displayMedia.length - 4 : 0;
            const visibleMedia = displayMedia.slice(0, extraCount > 0 ? 4 : displayMedia.length);
            const mediaCountClass = displayMedia.length >= 4 ? 'count-many' : ('count-' + displayMedia.length);
          %>
          <!-- Post Card -->
          <div class="card post-card" id="post-<%= post.id %>">
            <div class="card-body pb-2">

              <!-- Post Header -->
              <div class="d-flex align-items-center justify-content-between mb-3">
                <div class="d-flex align-items-center gap-2">
                  <% if (post.user.profile_image) { %>
                    <img src="/uploads/users/<%= post.user.profile_image %>" class="post-avatar" alt="<%= post.user.name %>">
                  <% } else { %>
                    <div class="post-avatar-initials">
                      <%= post.user.name ? post.user.name.charAt(0).toUpperCase() : 'U' %>
                    </div>
                  <% } %>
                  <div>
                    <a href="/user/profile/<%= post.user.id %>" class="post-username d-block"><%= post.user.name %></a>
                    <span class="post-timestamp">
                      <i class="ri-time-line me-1"></i>
                      <%
                        const now = new Date();
                        const postDate = new Date(post.createdAt);
                        const diffMs = now - postDate;
                        const diffMins = Math.floor(diffMs / 60000);
                        let timeAgo;
                        if (diffMins < 1) timeAgo = 'Just now';
                        else if (diffMins < 60) timeAgo = diffMins + 'm ago';
                        else if (diffMins < 1440) timeAgo = Math.floor(diffMins/60) + 'h ago';
                        else timeAgo = Math.floor(diffMins/1440) + 'd ago';
                      %>
                      <%= timeAgo %>
                    </span>
                  </div>
                </div>

                <!-- 3-dot menu (only for own posts) -->
                <% if (isOwn) { %>
                <div class="dropdown">
                  <button class="btn btn-sm btn-ghost-secondary p-1" data-bs-toggle="dropdown">
                    <i class="ri-more-2-fill fs-18"></i>
                  </button>
                  <ul class="dropdown-menu dropdown-menu-end">
                    <li>
                      <a class="dropdown-item" href="/user/posts/<%= post.id %>/edit">
                        <i class="ri-edit-line me-2"></i>Edit Post
                      </a>
                    </li>
                    <li>
                      <a class="dropdown-item text-danger" href="#"
                         onclick="confirmDeletePost(<%= post.id %>); return false;">
                        <i class="ri-delete-bin-line me-2"></i>Delete Post
                      </a>
                    </li>
                  </ul>
                </div>
                <% } %>
              </div>

              <!-- Post Content -->
              <p class="post-content-text"><%= post.content %></p>

              <!-- Media Grid -->
              <% if (displayMedia.length > 0) { %>
              <div class="media-grid <%= mediaCountClass %>">
                <% visibleMedia.forEach(function(item, idx) { %>
                  <div class="media-item">
                    <% if (item.type === 'image') { %>
                      <img src="/uploads/posts/<%= item.filename %>"
                           alt="Post image"
                           onclick="openMediaModal('<%= item.filename %>', 'image')">
                    <% } else { %>
                      <video controls preload="none">
                        <source src="/uploads/posts/<%= item.filename %>">
                      </video>
                    <% } %>
                    <% if (idx === 3 && extraCount > 0) { %>
                      <div class="media-more-overlay">+<%= extraCount %></div>
                    <% } %>
                  </div>
                <% }); %>
              </div>
              <% } %>

              <!-- Stats (likes & comments count) -->
              <div class="d-flex align-items-center justify-content-between mt-3 text-muted" style="font-size:13px;">
                <span>
                  <% if (post.likeCount > 0) { %>
                    <i class="ri-heart-fill text-danger me-1"></i><%= post.likeCount %> like<%= post.likeCount !== 1 ? 's' : '' %>
                  <% } %>
                </span>
                <span>
                  <% if (post.commentCount > 0) { %>
                    <%= post.commentCount %> comment<%= post.commentCount !== 1 ? 's' : '' %>
                  <% } %>
                </span>
              </div>

              <!-- Action Buttons -->
              <div class="post-actions d-flex">
                <button class="action-btn flex-fill justify-content-center like-btn <%= post.isLikedByCurrentUser ? 'liked' : '' %>"
                        data-post-id="<%= post.id %>"
                        data-liked="<%= post.isLikedByCurrentUser ? 'true' : 'false' %>">
                  <i class="<%= post.isLikedByCurrentUser ? 'ri-heart-fill' : 'ri-heart-line' %>"></i>
                  <span>Like</span>
                </button>
                <button class="action-btn flex-fill justify-content-center"
                        onclick="toggleComments(<%= post.id %>)">
                  <i class="ri-chat-3-line"></i>
                  <span>Comment</span>
                </button>
                <a href="/user/posts/<%= post.id %>" class="action-btn flex-fill justify-content-center text-decoration-none">
                  <i class="ri-eye-line"></i>
                  <span>View</span>
                </a>
              </div>

              <!-- Comments Preview (up to 2) -->
              <% if (post.comments && post.comments.length > 0) { %>
              <div class="comments-preview" id="comments-preview-<%= post.id %>">
                <% post.comments.slice(0, 2).forEach(function(comment) { %>
                <div class="comment-preview-item">
                  <% if (comment.user && comment.user.profile_image) { %>
                    <img src="/uploads/users/<%= comment.user.profile_image %>" class="comment-mini-avatar" alt="">
                  <% } else { %>
                    <div class="comment-mini-initials">
                      <%= comment.user && comment.user.name ? comment.user.name.charAt(0).toUpperCase() : 'U' %>
                    </div>
                  <% } %>
                  <div>
                    <span class="commenter-name"><%= comment.user ? comment.user.name : 'User' %></span>
                    <span class="commenter-text"><%= comment.comment %></span>
                  </div>
                </div>
                <% }); %>
                <% if (post.comments.length > 2) { %>
                  <a href="/user/posts/<%= post.id %>" class="fs-12 text-primary">
                    View all <%= post.comments.length %> comments
                  </a>
                <% } %>
              </div>
              <% } %>

              <!-- Inline comment box (hidden by default) -->
              <div class="comment-input-area mt-2" id="comment-area-<%= post.id %>" style="display:none;">
                <div class="d-flex gap-2 align-items-center">
                  <% if (currentUser.profile_image) { %>
                    <img src="/uploads/users/<%= currentUser.profile_image %>" class="comment-mini-avatar" alt="">
                  <% } else { %>
                    <div class="comment-mini-initials"><%= currentUser.name ? currentUser.name.charAt(0).toUpperCase() : 'U' %></div>
                  <% } %>
                  <form class="d-flex gap-2 flex-fill comment-submit-form"
                        data-post-id="<%= post.id %>">
                    <input type="text"
                           class="form-control form-control-sm"
                           placeholder="Write a comment..."
                           name="comment"
                           required
                           style="border-radius:20px;">
                    <button type="submit" class="btn btn-sm btn-primary" style="border-radius:20px; white-space:nowrap;">
                      <i class="ri-send-plane-fill"></i>
                    </button>
                  </form>
                </div>
              </div>

            </div>
          </div>
          <% }); %>
        <% } %>

      </div><!-- /.feed-main -->


      <!-- ========================
           RIGHT: SIDEBAR
      ======================== -->
      <div class="feed-sidebar">

        <!-- My Profile Stats Card -->
        <div class="card sidebar-card">
          <div class="card-body text-center pb-3">
            <% if (currentUser.profile_image) { %>
              <img src="/uploads/users/<%= currentUser.profile_image %>"
                   class="sidebar-profile-avatar mb-2" alt="<%= currentUser.name %>">
            <% } else { %>
              <div class="sidebar-profile-initials mx-auto mb-2">
                <%= currentUser.name ? currentUser.name.charAt(0).toUpperCase() : 'U' %>
              </div>
            <% } %>
            <h6 class="fw-semibold mb-0"><%= currentUser.name %></h6>
            <p class="text-muted fs-12 mb-3"><%= currentUser.email %></p>

            <div class="d-flex border rounded p-2 mb-3">
              <div class="stat-item">
                <span class="stat-number"><%= currentUser.postsCount || 0 %></span>
                <span class="stat-label">Posts</span>
              </div>
              <div class="stat-item border-start border-end">
                <span class="stat-number"><%= currentUser.followersCount || 0 %></span>
                <span class="stat-label">Followers</span>
              </div>
              <div class="stat-item">
                <span class="stat-number"><%= currentUser.followingCount || 0 %></span>
                <span class="stat-label">Following</span>
              </div>
            </div>

            <a href="/user/profile" class="btn btn-sm btn-outline-primary w-100">
              <i class="ri-user-line me-1"></i>View Profile
            </a>
          </div>
        </div>

        <!-- Suggested Users to Follow -->
        <% if (suggestedUsers && suggestedUsers.length > 0) { %>
        <div class="card sidebar-card">
          <div class="card-body">
            <h6 class="fw-semibold mb-3 d-flex align-items-center justify-content-between">
              <span>Suggested for you</span>
              <a href="/user/search" class="fs-12 text-primary fw-normal">See all</a>
            </h6>

            <% suggestedUsers.forEach(function(su) { %>
            <div class="suggested-user-item">
              <% if (su.profile_image) { %>
                <img src="/uploads/users/<%= su.profile_image %>" class="suggested-avatar" alt="<%= su.name %>">
              <% } else { %>
                <div class="suggested-initials">
                  <%= su.name ? su.name.charAt(0).toUpperCase() : 'U' %>
                </div>
              <% } %>

              <a href="/user/profile/<%= su.id %>" class="suggested-name" title="<%= su.name %>">
                <%= su.name %>
              </a>

              <form method="POST" action="/user/follow/<%= su.id %>" class="d-inline follow-form" data-user-id="<%= su.id %>">
                <button type="submit" class="btn btn-xs btn-soft-primary py-1 px-2 fs-11">
                  Follow
                </button>
              </form>
            </div>
            <% }); %>

          </div>
        </div>
        <% } %>

        <!-- Quick Links -->
        <div class="card sidebar-card">
          <div class="card-body pb-2">
            <h6 class="fw-semibold mb-3">Quick Links</h6>
            <a href="/user/notifications" class="d-flex align-items-center gap-2 text-decoration-none text-muted py-2 border-bottom hover-text-primary">
              <i class="ri-notification-3-line fs-18"></i>
              <span class="fs-13">Notifications</span>
            </a>
            <a href="/user/search" class="d-flex align-items-center gap-2 text-decoration-none text-muted py-2 border-bottom hover-text-primary">
              <i class="ri-search-line fs-18"></i>
              <span class="fs-13">Find People</span>
            </a>
            <a href="/user/profile" class="d-flex align-items-center gap-2 text-decoration-none text-muted py-2 hover-text-primary">
              <i class="ri-settings-3-line fs-18"></i>
              <span class="fs-13">Edit Profile</span>
            </a>
          </div>
        </div>

      </div><!-- /.feed-sidebar -->
    </div><!-- /.feed-wrapper -->

  </div><!-- /.container-fluid -->
</div><!-- /.page-content -->


<!-- ========================
     CREATE POST MODAL
======================== -->
<div class="modal fade" id="createPostModal" tabindex="-1" aria-labelledby="createPostModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered modal-lg">
    <div class="modal-content border-0 shadow-lg" style="border-radius:14px; overflow:hidden;">
      <div class="modal-header border-0 pb-0">
        <div class="d-flex align-items-center gap-2">
          <% if (currentUser.profile_image) { %>
            <img src="/uploads/users/<%= currentUser.profile_image %>" class="post-avatar" alt="<%= currentUser.name %>">
          <% } else { %>
            <div class="post-avatar-initials"><%= currentUser.name ? currentUser.name.charAt(0).toUpperCase() : 'U' %></div>
          <% } %>
          <div>
            <strong><%= currentUser.name %></strong>
            <span class="badge bg-success ms-1 fs-10">Public</span>
          </div>
        </div>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body pt-3">
        <form method="POST" action="/user/posts" enctype="multipart/form-data" id="createPostForm">
          <textarea name="content"
                    id="postContentArea"
                    class="form-control border-0 p-0 shadow-none"
                    rows="4"
                    placeholder="What's on your mind?"
                    style="font-size:16px; resize:none;"
                    required></textarea>

          <!-- Media Preview Area -->
          <div id="mediaPreviewArea" class="d-flex gap-2 flex-wrap mt-3" style="min-height:0;"></div>

          <hr>

          <!-- Upload Controls -->
          <div class="d-flex align-items-center justify-content-between flex-wrap gap-2">
            <div class="d-flex gap-2">
              <label class="btn btn-sm btn-soft-primary mb-0" style="cursor:pointer;">
                <i class="ri-image-line me-1"></i> Photos
                <input type="file" name="images" id="imageInput"
                       multiple accept="image/jpeg,image/png,image/gif,image/webp"
                       class="d-none" onchange="handleMediaPreview(this, 'image')">
              </label>
              <label class="btn btn-sm btn-soft-success mb-0" style="cursor:pointer;">
                <i class="ri-video-line me-1"></i> Videos
                <input type="file" name="videos" id="videoInput"
                       multiple accept="video/*"
                       class="d-none" onchange="handleMediaPreview(this, 'video')">
              </label>
            </div>
            <button type="submit" class="btn btn-primary btn-sm px-4" id="submitPostBtn" disabled>
              <i class="ri-send-plane-fill me-1"></i> Post
            </button>
          </div>
        </form>
      </div>
    </div>
  </div>
</div>


<!-- ========================
     IMAGE LIGHTBOX MODAL
======================== -->
<div class="modal fade" id="mediaLightboxModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered modal-xl">
    <div class="modal-content bg-transparent border-0">
      <div class="modal-body p-0 text-center">
        <button type="button" class="btn-close btn-close-white position-absolute top-0 end-0 m-3" data-bs-dismiss="modal" style="z-index:10;"></button>
        <img id="lightboxImg" src="" class="img-fluid rounded" style="max-height:85vh; object-fit:contain;" alt="Media">
      </div>
    </div>
  </div>
</div>


<!-- ========================
     PAGE SCRIPTS
======================== -->
<script>
// ── Enable Post button when content is typed ──────────────────────
const postContentArea = document.getElementById('postContentArea');
const submitPostBtn   = document.getElementById('submitPostBtn');

postContentArea?.addEventListener('input', function() {
  submitPostBtn.disabled = this.value.trim().length === 0;
});

// ── Media preview for create post modal ──────────────────────────
function handleMediaPreview(input, type) {
  const previewArea = document.getElementById('mediaPreviewArea');
  const files = Array.from(input.files);

  // Validate file count
  const maxCount = type === 'image' ? 10 : 5;
  const maxSizeMB = type === 'image' ? 5 : 15;

  for (const file of files) {
    if (file.size > maxSizeMB * 1024 * 1024) {
      Swal.fire({
        icon: 'error',
        title: 'File too large',
        text: `${file.name} exceeds the ${maxSizeMB}MB limit.`,
      });
      input.value = '';
      return;
    }
  }

  if (files.length > maxCount) {
    Swal.fire({
      icon: 'warning',
      title: 'Too many files',
      text: `You can upload up to ${maxCount} ${type}s.`,
    });
    input.value = '';
    return;
  }

  // Clear old previews of same type
  document.querySelectorAll(`.preview-item[data-type="${type}"]`).forEach(el => el.remove());

  files.forEach(file => {
    const url  = URL.createObjectURL(file);
    const wrap = document.createElement('div');
    wrap.className = 'preview-item position-relative';
    wrap.dataset.type = type;
    wrap.style.cssText = 'width:80px; height:80px; border-radius:8px; overflow:hidden; border:2px solid var(--vz-border-color);';

    if (type === 'image') {
      wrap.innerHTML = `<img src="${url}" style="width:100%;height:100%;object-fit:cover;">`;
    } else {
      wrap.innerHTML = `<video src="${url}" style="width:100%;height:100%;object-fit:cover;" muted></video>
                        <div style="position:absolute;inset:0;display:flex;align-items:center;justify-content:center;background:rgba(0,0,0,.4);">
                          <i class="ri-play-fill text-white fs-20"></i>
                        </div>`;
    }
    previewArea.appendChild(wrap);
  });

  // Enable submit if content exists or media chosen
  submitPostBtn.disabled = postContentArea.value.trim().length === 0 &&
    previewArea.children.length === 0;
}

// ── Open media in lightbox ────────────────────────────────────────
function openMediaModal(filename, type) {
  if (type === 'image') {
    document.getElementById('lightboxImg').src = '/uploads/posts/' + filename;
    const modal = new bootstrap.Modal(document.getElementById('mediaLightboxModal'));
    modal.show();
  }
}

// ── Toggle comment input area ─────────────────────────────────────
function toggleComments(postId) {
  const area = document.getElementById('comment-area-' + postId);
  if (!area) return;
  area.style.display = area.style.display === 'none' ? 'flex' : 'none';
  if (area.style.display !== 'none') {
    area.querySelector('input')?.focus();
  }
}

// ── Inline comment submit (AJAX) ──────────────────────────────────
document.querySelectorAll('.comment-submit-form').forEach(form => {
  form.addEventListener('submit', async function(e) {
    e.preventDefault();
    const postId  = this.dataset.postId;
    const input   = this.querySelector('input[name="comment"]');
    const comment = input.value.trim();
    if (!comment) return;

    try {
      const res = await fetch(`/user/posts/${postId}/comment`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ comment }),
      });

      if (res.ok) {
        input.value = '';
        // Reload page to show new comment
        window.location.reload();
      } else {
        Swal.fire({ icon: 'error', title: 'Error', text: 'Could not post comment.' });
      }
    } catch {
      Swal.fire({ icon: 'error', title: 'Error', text: 'Network error.' });
    }
  });
});

// ── Like toggle (AJAX) ───────────────────────────────────────────
document.querySelectorAll('.like-btn').forEach(btn => {
  btn.addEventListener('click', async function() {
    const postId = this.dataset.postId;
    const liked  = this.dataset.liked === 'true';

    try {
      const res = await fetch(`/user/posts/${postId}/like`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
      });

      if (res.ok) {
        const data = await res.json();
        const isNowLiked = data.liked;

        this.dataset.liked = isNowLiked ? 'true' : 'false';
        this.classList.toggle('liked', isNowLiked);

        const icon = this.querySelector('i');
        icon.className = isNowLiked ? 'ri-heart-fill' : 'ri-heart-line';

        // Update like count display
        const card     = document.getElementById('post-' + postId);
        const countEl  = card?.querySelector('.text-danger')?.parentElement;
        if (countEl && data.likeCount !== undefined) {
          countEl.innerHTML = isNowLiked
            ? `<i class="ri-heart-fill text-danger me-1"></i>${data.likeCount} like${data.likeCount !== 1 ? 's' : ''}`
            : (data.likeCount > 0 ? `<i class="ri-heart-fill text-danger me-1"></i>${data.likeCount} likes` : '');
        }
      }
    } catch {
      Swal.fire({ icon: 'error', title: 'Error', text: 'Could not update like.' });
    }
  });
});

// ── Delete Post confirmation ──────────────────────────────────────
function confirmDeletePost(postId) {
  Swal.fire({
    title: 'Delete Post?',
    text: 'This action cannot be undone.',
    icon: 'warning',
    showCancelButton: true,
    confirmButtonColor: '#d33',
    cancelButtonColor: '#aaa',
    confirmButtonText: 'Yes, delete it',
  }).then((result) => {
    if (result.isConfirmed) {
      fetch(`/user/posts/${postId}`, { method: 'DELETE' })
        .then(res => {
          if (res.ok) {
            document.getElementById('post-' + postId)?.remove();
            Swal.fire({ icon: 'success', title: 'Deleted!', text: 'Your post has been removed.', timer: 1500, showConfirmButton: false });
          }
        })
        .catch(() => Swal.fire({ icon: 'error', title: 'Error', text: 'Could not delete post.' }));
    }
  });
}

// ── Follow button AJAX (sidebar suggestions) ─────────────────────
document.querySelectorAll('.follow-form').forEach(form => {
  form.addEventListener('submit', async function(e) {
    e.preventDefault();
    const userId = this.dataset.userId;

    try {
      const res = await fetch(`/user/follow/${userId}`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
      });

      if (res.ok) {
        const btn = this.querySelector('button');
        btn.textContent = 'Following';
        btn.classList.remove('btn-soft-primary');
        btn.classList.add('btn-soft-success');
        btn.disabled = true;
      }
    } catch {
      Swal.fire({ icon: 'error', title: 'Error', text: 'Could not follow user.' });
    }
  });
});
</script>

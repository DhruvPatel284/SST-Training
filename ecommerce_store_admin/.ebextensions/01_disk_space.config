commands:
  01_increase_swap:
    command: |
      set -e
      SWAPFILE=/var/swapfile
      SWAP_SIZE=2048
      
      # Check if swap already exists
      if [ ! -f $SWAPFILE ]; then
        echo "Creating ${SWAP_SIZE}MB swap file..."
        dd if=/dev/zero of=$SWAPFILE bs=1M count=$SWAP_SIZE
        chmod 600 $SWAPFILE
        mkswap $SWAPFILE
        swapon $SWAPFILE
        echo "$SWAPFILE none swap sw 0 0" >> /etc/fstab
        echo "Swap file created and activated"
      fi
      
      # Verify swap
      swapon -s
      free -h
    test: '[ ! -f /var/swapfile ]'
  
  02_cleanup_old_deployments:
    command: |
      # Clean up old node_modules to free space
      find /var/app -name "node_modules" -type d -mtime +7 -exec rm -rf {} + 2>/dev/null || true
      
      # Clean npm cache
      npm cache clean --force 2>/dev/null || true
      
      # Clean yum cache
      yum clean all 2>/dev/null || true
      
      # Remove old logs
      find /var/log -type f -name "*.log" -mtime +7 -delete 2>/dev/null || true
      
      df -h
    ignoreErrors: true

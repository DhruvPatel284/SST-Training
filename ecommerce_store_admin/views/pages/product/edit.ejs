<%- contentFor('HeaderCss') %>
<style>
  .image-preview-container {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
    gap: 1rem;
  }
  .image-preview-item {
    position: relative;
    border: 2px solid #e9ebec;
    border-radius: 8px;
    overflow: hidden;
    aspect-ratio: 1;
  }
  .image-preview-item img {
    width: 100%;
    height: 100%;
    object-fit: cover;
  }
  .image-delete-btn {
    position: absolute;
    top: 0.5rem;
    right: 0.5rem;
    padding: 0.25rem 0.5rem;
    background: rgba(240, 101, 72, 0.9);
    border: none;
    border-radius: 4px;
    color: white;
    cursor: pointer;
    font-size: 0.75rem;
  }
  .image-delete-btn:hover {
    background: rgba(240, 101, 72, 1);
  }
</style>

<%- contentFor('body') %>

<div class="row">
  <% const successFlash = typeof success !== 'undefined' ? success : null; %>
  <% const errorFlash = typeof error !== 'undefined' ? error : null; %>
  
  <% if (successFlash) { %>
  <div class="col-12">
    <div class="alert alert-success alert-dismissible fade show" role="alert">
      <i class="ri-checkbox-circle-line me-1"></i> <%= successFlash %>
      <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    </div>
  </div>
  <% } %>
  <% if (errorFlash) { %>
  <div class="col-12">
    <div class="alert alert-danger alert-dismissible fade show" role="alert">
      <i class="ri-error-warning-line me-1"></i> <%= errorFlash %>
      <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    </div>
  </div>
  <% } %>

  <div class="col-lg-8">
    <div class="card">
      <div class="card-header align-items-center d-flex">
        <h4 class="card-title mb-0 flex-grow-1">Product Details</h4>
      </div>
      <div class="card-body">
        <form
          action="/products/<%- product.id %>?_method=put"
          method="POST"
          class="needs-validation"
          id="edit-product-form"
          novalidate
        >
          <div class="mb-3">
            <label for="name" class="form-label">Product Name</label>
            <input
              type="text"
              class="form-control"
              name="name"
              value="<%- old ? old.name : product.name %>"
              placeholder="Enter product name"
              id="name"
              required
            />
            <% if (errors && errors.name) { %>
            <div class="text-danger"><%= errors.name[0] %></div>
            <% } %>
          </div>

          <div class="row">
            <div class="col-md-6">
              <div class="mb-3">
                <label for="price" class="form-label">Price</label>
                <input
                  type="number"
                  class="form-control"
                  name="price"
                  value="<%- old ? old.price : product.price %>"
                  placeholder="0.00"
                  id="price"
                  step="0.01"
                  min="0"
                  required
                />
                <% if (errors && errors.price) { %>
                <div class="text-danger"><%= errors.price[0] %></div>
                <% } %>
              </div>
            </div>
            <div class="col-md-6">
              <div class="mb-3">
                <label for="stock" class="form-label">Stock Quantity</label>
                <input
                  type="number"
                  class="form-control"
                  name="stock"
                  value="<%- old ? old.stock : product.stock %>"
                  placeholder="0"
                  id="stock"
                  min="0"
                  required
                />
                <% if (errors && errors.stock) { %>
                <div class="text-danger"><%= errors.stock[0] %></div>
                <% } %>
              </div>
            </div>
          </div>

          <div class="mb-3">
            <label for="category" class="form-label">Category</label>
            <input
              type="text"
              class="form-control"
              name="category"
              value="<%- old ? old.category : product.category %>"
              placeholder="Enter category"
              id="category"
              required
            />
            <% if (errors && errors.category) { %>
            <div class="text-danger"><%= errors.category[0] %></div>
            <% } %>
          </div>

          <div class="d-flex gap-2">
            <button type="submit" class="btn btn-primary">
              <i class="ri-save-line align-bottom me-1"></i> Update Product
            </button>
            <a href="/products/<%- product.id %>" class="btn btn-secondary">
              Cancel
            </a>
          </div>
        </form>
      </div>
    </div>
  </div>

  <div class="col-lg-4">
    <div class="card">
      <div class="card-header">
        <h5 class="card-title mb-0">
          <i class="ri-image-line me-1"></i>
          Product Images
          <span class="badge bg-primary-subtle text-primary ms-2">
            <%= product.images ? product.images.length : 0 %> / 5
          </span>
        </h5>
      </div>
      <div class="card-body">
        <% if (product.images && product.images.length > 0) { %>
        <div class="image-preview-container mb-3">
          <% product.images.forEach((image, index) => { %>
          <div class="image-preview-item">
            <img
              src="/uploads/products/<%= image.filename %>"
              alt="Product image <%= index + 1 %>"
            />
            <button 
              type="button"
              class="image-delete-btn remove-image-btn"
              data-product-id="<%= product.id %>"
              data-image-id="<%= image.id %>"
              data-bs-toggle="modal"
              data-bs-target="#deleteImageModal">
              <i class="ri-delete-bin-line"></i>
            </button>
          </div>
          <% }) %>
        </div>
        <% } else { %>
        <p class="text-muted text-center mb-3">No images uploaded yet</p>
        <% } %>

        <% if (!product.images || product.images.length < 5) { %>
        <% const remainingSlots = 5 - (product.images ? product.images.length : 0); %>
        <form
          action="/products/<%= product.id %>/images"
          method="POST"
          enctype="multipart/form-data"
          id="upload-form"
        >
          <div class="mb-3">
            <label for="image-input" class="form-label">Select Images</label>
            <input
              type="file"
              name="images"
              id="image-input"
              class="form-control"
              accept="image/jpeg,image/jpg,image/png,image/gif,image/webp"
              multiple
              required
            />
            <small class="text-muted">
              Max <%= remainingSlots %> image(s), 5MB each. JPEG, PNG, GIF, WebP only.
            </small>
          </div>
          <div id="selected-files"></div>
          <button type="submit" class="btn btn-success w-100">
            <i class="ri-upload-line align-bottom me-1"></i>
            Upload Images
          </button>
        </form>
        <% } else { %>
        <div class="alert alert-info mb-0">
          <i class="ri-information-line me-1"></i>
          Maximum of 5 images reached. Delete an image to upload more.
        </div>
        <% } %>
      </div>
    </div>
  </div>
</div>

<!-- Delete Image Confirmation Modal -->
<div
  id="deleteImageModal"
  class="modal fade zoomIn"
  tabindex="-1"
  aria-hidden="true"
>
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header">
        <button
          type="button"
          class="btn-close"
          data-bs-dismiss="modal"
          aria-label="Close"
        ></button>
      </div>
      <div class="modal-body">
        <div class="mt-2 text-center">
          <lord-icon
            src="https://cdn.lordicon.com/gsqxdxog.json"
            trigger="loop"
            colors="primary:#f7b84b,secondary:#f06548"
            style="width: 100px; height: 100px"
          ></lord-icon>
          <div class="mt-4 pt-2 fs-15 mx-4 mx-sm-5">
            <h4>Are you sure?</h4>
            <p class="text-muted mx-4 mb-0">
              Are you sure you want to remove this image?
            </p>
            <input type="hidden" id="modal-product-id" />
            <input type="hidden" id="modal-image-id" />
          </div>
        </div>
        <div class="d-flex gap-2 justify-content-center mt-4 mb-2">
          <button
            type="button"
            class="btn w-sm btn-light"
            data-bs-dismiss="modal"
          >
            Close
          </button>
          <button
            type="button"
            class="btn w-sm btn-danger"
            id="confirm-delete-image"
          >
            Yes, Delete It!
          </button>
        </div>
      </div>
    </div>
  </div>
</div>

<%- contentFor('FooterJs') %>
<script>
(function() {
  console.log('=== Product Edit Page Script Loaded ===');
  console.log('jQuery loaded:', typeof jQuery !== 'undefined');
  console.log('Bootstrap loaded:', typeof bootstrap !== 'undefined');

  // ── File selection preview ──────────────────────────────────────────
  var uploadForm = document.getElementById('upload-form');
  var imageInput = document.getElementById('image-input');
  
  if (imageInput) {
    imageInput.addEventListener('change', function() {
      var files = this.files;
      var selectedDiv = document.getElementById('selected-files');
      
      if (files.length > 0) {
        var names = Array.from(files).map(function(f) { return f.name; }).join(', ');
        selectedDiv.innerHTML = '<div class="alert alert-success mt-2"><i class="ri-checkbox-circle-line me-1"></i>' + 
          files.length + ' file(s) selected: ' + names + '</div>';
      } else {
        selectedDiv.innerHTML = '';
      }
    });
  }
  
  // ── Upload form validation ──────────────────────────────────────────
  if (uploadForm) {
    uploadForm.addEventListener('submit', function(e) {
      var files = imageInput.files;
      
      if (files.length === 0) {
        e.preventDefault();
        alert('Please select at least one image');
        return false;
      }
      
      for (var i = 0; i < files.length; i++) {
        if (files[i].size > 5 * 1024 * 1024) {
          e.preventDefault();
          alert('File "' + files[i].name + '" exceeds 5MB');
          return false;
        }
      }
      
      console.log('Submitting to:', this.action, 'with', files.length, 'files');
      return true;
    });
  }

  // ── Delete image - store IDs when modal opens ──────────────────────
  var removeButtons = document.querySelectorAll('.remove-image-btn');
  console.log('Found delete buttons:', removeButtons.length);
  
  removeButtons.forEach(function(btn) {
    btn.addEventListener('click', function() {
      var productId = this.getAttribute('data-product-id');
      var imageId = this.getAttribute('data-image-id');
      console.log('Delete button clicked - Product:', productId, 'Image:', imageId);
      document.getElementById('modal-product-id').value = productId;
      document.getElementById('modal-image-id').value = imageId;
    });
  });

  // ── Confirm delete button handler ──────────────────────────────────
  var confirmBtn = document.getElementById('confirm-delete-image');
  console.log('Confirm button found:', confirmBtn !== null);
  
  if (confirmBtn) {
    confirmBtn.addEventListener('click', function() {
      console.log('Confirm delete clicked');
      
      var productId = document.getElementById('modal-product-id').value;
      var imageId = document.getElementById('modal-image-id').value;
      
      console.log('Deleting - Product:', productId, 'Image:', imageId);
      
      if (!productId || !imageId) {
        console.error('Missing IDs!');
        alert('Error: Missing product or image ID');
        return;
      }

      // Close modal
      var modal = document.getElementById('deleteImageModal');
      var bsModal = bootstrap.Modal.getInstance(modal);
      if (bsModal) {
        bsModal.hide();
      }

      // Create and submit form
      var form = document.createElement('form');
      form.method = 'POST';
      form.action = '/products/' + productId + '/images/' + imageId + '?_method=DELETE';

      var input = document.createElement('input');
      input.type = 'hidden';
      input.name = '_method';
      input.value = 'DELETE';
      form.appendChild(input);

      document.body.appendChild(form);
      console.log('Submitting form to:', form.action);
      form.submit();
    });
  } else {
    console.error('Confirm button not found!');
  }
})();
</script>
